<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í•œë‚˜ì™€ ì„ë¯¼ì´ì˜ ê³µìœ ì¼ê¸°ì¥</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fffaf3;
      margin: 0;
      padding: 0;
    }
    .container {
      display: none; /* ë¡œê·¸ì¸ ì „ì—” ìˆ¨ê¹€ */
      flex-direction: row;
      height: 100vh;
    }
    .left, .right {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .left {
      border-right: 1px solid #ccc;
    }
    .editor {
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      min-height: 150px;
    }
    .controls select, .controls button {
      padding: 8px 12px;
      margin: 5px;
      border-radius: 8px;
      font-size: 14px;
    }
    #preview { max-width: 200px; margin: 10px auto; display: none; }
    .pink-bg { background-color: #ffe6f0; }
    .blue-bg { background-color: #e6f3ff; }
    #commentText { width: 100%; border-radius: 8px; resize: none; height: 60px; }
    .auth-buttons {
      text-align: center;
      padding: 50px;
    }
    @media (max-width: 768px) {
      .container { flex-direction: column; height: auto; }
      .left, .right { border: none; height: auto; }
    }
  </style>
</head>
<body>
<h2 style="text-align:center; padding:10px;">ğŸŒ¸ í•œë‚˜ì™€ ì„ë¯¼ì´ì˜ ê³µìœ ì¼ê¸°ì¥ ğŸŒ¸</h2>

<!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
<div class="auth-buttons" id="login-area">
  <button id="login-btn">ğŸ” Google ë¡œê·¸ì¸</button>
</div>

<!-- ì¼ê¸°ì¥ ì˜ì—­ -->
<div class="container" id="diary-app">
  <div class="left">
    <div class="controls">
      <label id="user-label"></label>
      <button onclick="saveDiary()">ğŸ“‚ ì¼ê¸° ì €ì¥</button>
    </div>
    <div id="editor" class="editor" contenteditable="true"></div>
    <input type="file" id="imageInput" accept="image/*" onchange="previewImage()" />
    <img id="preview" src="">
  </div>
  <div class="right">
    <h3>ğŸ“š ì €ì¥ëœ ì¼ê¸° ëª©ë¡</h3>
    <div id="list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="viewEntry"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDocs, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUriLDY8uRXONDUDVRLtbu1VI2iRvc-Bk",
    authDomain: "couple-diary-1f390.firebaseapp.com",
    projectId: "couple-diary-1f390",
    storageBucket: "couple-diary-1f390.appspot.com",
    messagingSenderId: "274498048639",
    appId: "1:274498048639:web:3706b378a8281c2a47654a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const provider = new GoogleAuthProvider();

  const loginBtn = document.getElementById("login-btn");
  const loginArea = document.getElementById("login-area");
  const diaryApp = document.getElementById("diary-app");
  const userLabel = document.getElementById("user-label");
  const editor = document.getElementById("editor");
  const preview = document.getElementById("preview");
  let imageFile = null;
  let currentUser = null;

  loginBtn.onclick = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      currentUser = result.user;
      showDiaryApp();
    } catch (error) {
      alert("ë¡œê·¸ì¸ ì‹¤íŒ¨!");
    }
  };

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      showDiaryApp();
    }
  });

  function showDiaryApp() {
    loginArea.style.display = "none";
    diaryApp.style.display = "flex";
    userLabel.innerText = `ğŸ‘¤ ${currentUser.displayName}`;
    insertDefaultEntryText();
    loadDiaryList();
  }

  async function saveDiary() {
    const content = editor.innerHTML;
    const now = new Date();
    const dateId = now.toISOString().slice(0, 10);
    const uid = currentUser.uid;
    const entryRef = doc(collection(db, `diary/${uid}/entries/${dateId}`)); // random entry

    let imageUrl = "";
    if (imageFile) {
      const storageRef = ref(storage, `${uid}/${dateId}_${imageFile.name}`);
      await uploadBytes(storageRef, imageFile);
      imageUrl = await getDownloadURL(storageRef);
    }

    await setDoc(entryRef, {
      content,
      createdAt: now.toLocaleString(),
      image: imageUrl
    });

    alert("ğŸŒ¼ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    editor.innerHTML = "";
    imageFile = null;
    preview.style.display = "none";
    insertDefaultEntryText();
    loadDiaryList();
  }

  async function loadDiaryList() {
    const uid = currentUser.uid;
    const rootRef = collection(db, `diary/${uid}/entries`);
    const rootSnap = await getDocs(rootRef);

    let html = "<ul>";
    for (const folder of rootSnap.docs) {
      const dateId = folder.id;
      const entriesRef = collection(db, `diary/${uid}/entries/${dateId}`);
      const entriesSnap = await getDocs(entriesRef);
      entriesSnap.forEach(doc => {
        html += `<li onclick="viewDiary('${uid}', '${dateId}', '${doc.id}')">${dateId} - ${doc.id}</li>`;
      });
    }
    html += "</ul>";
    document.getElementById("list").innerHTML = html;
  }

  window.viewDiary = async function(uid, dateId, entryId) {
    const docRef = doc(db, `diary/${uid}/entries/${dateId}/${entryId}`);
    const snap = await getDoc(docRef);
    const data = snap.data();

    let html = `
      <h3>ğŸ“– ì¼ê¸° (${dateId})</h3>
      <div style="padding:10px; border-radius:10px; background:#f9f9f9;">
        ${data.content}
        ${data.image ? `<br><img src="${data.image}" style="max-width:100%; margin-top:10px;">` : ""}
      </div>
      <textarea id="commentText" placeholder="ëŒ“ê¸€ ì‘ì„±" style="margin-top:10px;"></textarea>
      <button onclick="saveComment('${uid}', '${dateId}', '${entryId}')">ëŒ“ê¸€ ì €ì¥</button>
    `;

    const commentRef = collection(db, `diary/${uid}/entries/${dateId}/${entryId}/comments`);
    const comments = await getDocs(commentRef);
    html += `<div><h4>ğŸ“† ëŒ“ê¸€</h4><ul>`;
    comments.forEach(c => {
      html += `<li>${c.data().text} (${c.data().timestamp})</li>`;
    });
    html += `</ul></div>`;
    document.getElementById("viewEntry").innerHTML = html;
  };

  window.saveComment = async function(uid, dateId, entryId) {
    const textarea = document.getElementById("commentText");
    const text = textarea.value;
    const now = new Date().toLocaleString();
    const commentRef = collection(db, `diary/${uid}/entries/${dateId}/${entryId}/comments`);
    await addDoc(commentRef, { text, timestamp: now });
    await viewDiary(uid, dateId, entryId);
    textarea.value = "";
  };

  window.previewImage = function() {
    const input = document.getElementById("imageInput");
    imageFile = input.files[0];
    if (imageFile) {
      preview.src = URL.createObjectURL(imageFile);
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
    }
  };

  async function insertDefaultEntryText() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
    const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    editor.innerHTML = `<p><strong>${dateStr} Â· ${timeStr}</strong></p><p><br></p>`;
  }
</script>
</body>
</html>
